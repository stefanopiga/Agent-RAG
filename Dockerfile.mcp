# Dockerfile for MCP HTTP Server (porta 8080)
# Multi-stage build for optimized image size < 500MB
# AC4.3.11, AC4.3.12, AC4.3.13, AC4.3.14

# ============================================================================
# BUILDER STAGE
# Install build dependencies and compile Python packages
# ============================================================================
FROM python:3.11-slim AS builder

# Install uv for fast dependency management
COPY --from=ghcr.io/astral-sh/uv:latest /uv /bin/uv

# Install build dependencies (NOT included in final image)
RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential \
    && rm -rf /var/lib/apt/lists/*

# Set working directory
WORKDIR /app

# uv optimizations
ENV UV_COMPILE_BYTECODE=1
ENV UV_LINK_MODE=copy

# Copy project definition
COPY pyproject.toml uv.lock ./

# Install MCP dependencies (includes docling for document processing)
# --frozen: Uses exact versions from lockfile
# --no-install-project: Installs only libraries, not your code yet
# --no-editable: Remove dependency on source code for multi-stage builds
# --extra mcp: Install mcp group with docling
RUN --mount=type=cache,target=/root/.cache/uv \
    uv sync --frozen --no-install-project --no-editable --extra mcp

# Copy ONLY necessary application code
COPY docling_mcp/ ./docling_mcp/
COPY core/ ./core/
COPY ingestion/ ./ingestion/
COPY utils/ ./utils/
COPY client/ ./client/

# Install current project
RUN --mount=type=cache,target=/root/.cache/uv \
    uv sync --frozen --no-editable --extra mcp

# ============================================================================
# RUNTIME STAGE
# Minimal image with only runtime dependencies
# ============================================================================
FROM python:3.11-slim AS runtime

# Install ONLY runtime dependencies (no build tools)
# - curl: for health checks
RUN apt-get update && apt-get install -y --no-install-recommends \
    curl \
    && rm -rf /var/lib/apt/lists/*

# Set working directory
WORKDIR /app

# Set environment variables
ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1 \
    PYTHONPATH=/app

# Copy virtual environment from builder stage
COPY --from=builder /app/.venv /app/.venv

# Copy ONLY necessary application code from builder stage
COPY --from=builder /app/docling_mcp ./docling_mcp/
COPY --from=builder /app/core ./core/
COPY --from=builder /app/ingestion ./ingestion/
COPY --from=builder /app/utils ./utils/
COPY --from=builder /app/client ./client/

# Add virtual environment to PATH
ENV PATH="/app/.venv/bin:$PATH"

# Expose MCP HTTP server port
EXPOSE 8080

# Health check with extended start-period to allow embedder initialization (40+ seconds)
HEALTHCHECK --interval=30s --timeout=5s --start-period=60s --retries=3 \
  CMD curl -f http://localhost:8080/health || exit 1

# Start the MCP HTTP server
CMD ["python", "-m", "docling_mcp.http_server"]
